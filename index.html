<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conversation Practice</title>
<style>
  body { 
    font-family: system-ui, -apple-system, sans-serif;
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
    background: #f8f9fa;
  }
  h1 { 
    color: #2c3e50;
    margin-bottom: 10px;
  }
  .lead { 
    color: #666;
    margin-bottom: 30px;
  }
  .line { 
    background: white;
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .speaker { 
    font-weight: bold;
    color: #0066cc;
    font-size: 1.1rem;
    margin-bottom: 8px;
  }
  .english { 
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: #000;
  }
  .phonetic { 
    color: #888;
    font-style: italic;
    margin-bottom: 8px;
  }
  .spanish { 
    color: #555;
    margin-bottom: 12px;
  }
  .buttons { 
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  button { 
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    background: #0066cc;
    color: white;
    cursor: pointer;
    font-size: 1rem;
  }
  button:hover { 
    background: #0052a3;
  }
  button:active { 
    transform: scale(0.98);
  }
  .result { 
    font-weight: bold;
    margin-top: 10px;
  }
  .transcript-box {
    background: #f0f8ff;
    border: 2px solid #0066cc;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
    min-height: 60px;
    font-size: 1.1rem;
    color: #333;
    font-style: italic;
  }
  .listening {
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }
  footer { 
    text-align: center;
    color: #666;
    margin-top: 40px;
    font-size: 0.9rem;
  }
</style>
</head>
<body>
  <h1>üéì Meeting at the University</h1>
  <p class="lead">Pulsa üéß para escuchar, üéôÔ∏è para practicar tu pronunciaci√≥n. El sistema compara tu transcripci√≥n con la frase original.</p>

  <div id="conversation"></div>

  <footer>üé§ Usa Google Chrome o Edge para practicar. La puntuaci√≥n es estimada seg√∫n coincidencia de palabras.</footer>

<script>
const lines = [
  {speaker:'Sara', english:'Hi! Is this seat taken?', phonetic:'J√°i, is dis s√≠it t√©iken?', spanish:'¬°Hola! ¬øEst√° ocupado este asiento?'},
  {speaker:'Emily', english:'Oh, no, go ahead!', phonetic:'Ou, n√≥u, g√≥u aj√©d!', spanish:'¬°Oh, no, adelante!'},
  {speaker:'Sara', english:'Thanks! I am Sara, by the way.', phonetic:'Z√°nks, √°im S√°ra, bai de w√©y.', spanish:'Gracias, soy Sara, por cierto.'},
  {speaker:'Emily', english:'Nice to meet you, Sara! I am Emily.', phonetic:'N√°is tu m√≠tiu, S√°ra! √Åim √âmili.', spanish:'Encantada de conocerte, Sara. Soy Emily.'},
  {speaker:'Sara', english:'Nice to meet you too! Are you a first year student?', phonetic:'N√°is tu m√≠tiu t√∫u! Ar yu a f√©rst y√≠er st√∫dent?', spanish:'¬°Encantada tambi√©n! ¬øEres estudiante de primer a√±o?'},
  {speaker:'Emily', english:'Yes, I am! I am studying psychology. What about you?', phonetic:'Y√©s, ai √°m! √Åim st√°diing saic√≥loy√≠. Juat ab√°ut y√∫?', spanish:'¬°S√≠! Estoy estudiando psicolog√≠a. ¬øY t√∫?'},
  {speaker:'Sara', english:'I am studying education. This is my first week here.', phonetic:'√Åim st√°diing eduki√©ishon. Dis is mai f√©rst u√≠ik j√≠er.', spanish:'Estoy estudiando educaci√≥n. Esta es mi primera semana aqu√≠.'},
  {speaker:'Emily', english:'Same here! Everything feels so new and exciting.', phonetic:'S√©im j√≠er! √âvryzing f√≠ils s√≥u ni√∫ and ex√°itin.', spanish:'¬°Igual! Todo se siente tan nuevo y emocionante.'},
  {speaker:'Sara', english:'Totally! We should grab a coffee sometime.', phonetic:'T√≥urali! Wi shud gr√°b a c√≥fi somtaim.', spanish:'¬°Totalmente! Deber√≠amos tomar un caf√© alg√∫n d√≠a.'},
  {speaker:'Emily', english:'I would love that! Let us exchange numbers.', phonetic:'A√≠d l√≥v d√°t! L√©ts exch√©insh nambers.', spanish:'¬°Me encantar√≠a! Intercambiemos n√∫meros.'}
];

const convEl = document.getElementById('conversation');

function renderConversation(){
  lines.forEach((line, i) => {
    const div = document.createElement('div');
    div.className = 'line';
    
    const speaker = document.createElement('div');
    speaker.className = 'speaker';
    speaker.textContent = line.speaker;
    
    const english = document.createElement('div');
    english.className = 'english';
    english.textContent = line.english;
    
    const phonetic = document.createElement('div');
    phonetic.className = 'phonetic';
    phonetic.textContent = line.phonetic;
    
    const spanish = document.createElement('div');
    spanish.className = 'spanish';
    spanish.textContent = line.spanish;
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'buttons';
    
    const playBtn = document.createElement('button');
    playBtn.textContent = 'üéß Play';
    playBtn.onclick = () => playLine(i);
    
    const practiceBtn = document.createElement('button');
    practiceBtn.textContent = 'üéôÔ∏è Practice';
    practiceBtn.onclick = () => practiceLine(i);
    
    const resultSpan = document.createElement('span');
    resultSpan.className = 'result';
    resultSpan.id = 'result-' + i;
    
    const transcriptBox = document.createElement('div');
    transcriptBox.className = 'transcript-box';
    transcriptBox.id = 'transcript-' + i;
    transcriptBox.style.display = 'none';
    
    buttonsDiv.appendChild(playBtn);
    buttonsDiv.appendChild(practiceBtn);
    buttonsDiv.appendChild(resultSpan);
    
    div.appendChild(speaker);
    div.appendChild(english);
    div.appendChild(phonetic);
    div.appendChild(spanish);
    div.appendChild(buttonsDiv);
    div.appendChild(transcriptBox);
    
    convEl.appendChild(div);
  });
}

renderConversation();

let voices = [];
function loadVoices(){
  voices = speechSynthesis.getVoices();
}
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = loadVoices;
}
loadVoices();

function playLine(i){
  const line = lines[i];
  speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(line.english);
  utterance.lang = 'en-US';
  utterance.rate = 0.9;
  const voice = voices.find(v => v.lang.includes('en-US') || v.lang.includes('en_US'));
  if(voice) utterance.voice = voice;
  speechSynthesis.speak(utterance);
}

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

function practiceLine(i){
  if(!SpeechRecognition){
    alert('Tu navegador no soporta reconocimiento de voz. Usa Chrome o Edge.');
    return;
  }

  const resultEl = document.getElementById('result-' + i);
  const transcriptBox = document.getElementById('transcript-' + i);
  const practiceBtn = document.querySelector(`#conversation .line:nth-child(${i+1}) button:nth-child(2)`);
  
  // Si ya est√° grabando, detener
  if(window.activeRecognition && window.activeRecognitionIndex === i){
    window.activeRecognition.stop();
    practiceBtn.textContent = 'üéôÔ∏è Practice';
    practiceBtn.style.background = '#0066cc';
    window.activeRecognition = null;
    window.activeRecognitionIndex = null;
    return;
  }
  
  // Detener cualquier reconocimiento activo
  if(window.activeRecognition){
    window.activeRecognition.stop();
    const oldBtn = document.querySelector(`#conversation .line:nth-child(${window.activeRecognitionIndex+1}) button:nth-child(2)`);
    if(oldBtn){
      oldBtn.textContent = 'üéôÔ∏è Practice';
      oldBtn.style.background = '#0066cc';
    }
  }
  
  const rec = new SpeechRecognition();
  rec.lang = 'en-US';
  rec.interimResults = true;
  rec.maxAlternatives = 1;
  rec.continuous = true;

  window.activeRecognition = rec;
  window.activeRecognitionIndex = i;

  resultEl.textContent = 'üéôÔ∏è Grabando... presiona "Parar" cuando termines';
  resultEl.style.color = '#666';
  
  // Cambiar bot√≥n a "Parar"
  practiceBtn.textContent = '‚èπÔ∏è Parar';
  practiceBtn.style.background = '#dc3545';
  
  // Mostrar caja de transcripci√≥n
  transcriptBox.style.display = 'block';
  transcriptBox.className = 'transcript-box listening';
  transcriptBox.textContent = 'üé§ Esperando...';

  let fullTranscript = '';
  let lastProcessedIndex = 0;

  rec.onstart = () => {
    console.log('Recognition started');
    transcriptBox.textContent = 'üé§ Habla ahora...';
    fullTranscript = '';
    lastProcessedIndex = 0;
  };

  rec.onresult = (e) => {
    let interimTranscript = '';
    let newFinalTranscript = '';
    
    // Procesar solo resultados desde el √∫ltimo √≠ndice procesado
    for (let i = lastProcessedIndex; i < e.results.length; i++) {
      const transcript = e.results[i][0].transcript;
      if (e.results[i].isFinal) {
        newFinalTranscript += transcript + ' ';
        lastProcessedIndex = i + 1;
      } else {
        interimTranscript = transcript;
      }
    }
    
    // Agregar nuevo texto final al acumulado
    if(newFinalTranscript){
      fullTranscript += newFinalTranscript;
    }
    
    // Mostrar transcripci√≥n en tiempo real (estilo karaoke)
    const displayText = (fullTranscript + interimTranscript).trim();
    if (displayText) {
      transcriptBox.innerHTML = 'üé§ <span style="color: #0066cc;">' + displayText + '</span>';
    }
  };

  rec.onspeechend = () => {
    // NO detener autom√°ticamente en pausas
    console.log('Speech pause detected, continuing...');
  };

  rec.onerror = (e) => {
    console.log('Recognition error:', e.error);
    
    // Restaurar bot√≥n
    practiceBtn.textContent = 'üéôÔ∏è Practice';
    practiceBtn.style.background = '#0066cc';
    window.activeRecognition = null;
    window.activeRecognitionIndex = null;
    
    if(e.error === 'no-speech'){
      transcriptBox.innerHTML = '‚ö†Ô∏è No se detect√≥ voz. Intenta de nuevo';
      transcriptBox.style.display = 'block';
    } else if(e.error === 'not-allowed'){
      transcriptBox.style.display = 'none';
      resultEl.textContent = '‚ö†Ô∏è Permiso denegado. Activa el micr√≥fono';
      resultEl.style.color = 'red';
    } else if(e.error !== 'aborted'){
      transcriptBox.style.display = 'none';
      resultEl.textContent = '‚ùå Error: ' + e.error;
      resultEl.style.color = 'red';
    }
  };

  rec.onend = () => {
    console.log('Recognition ended');
    transcriptBox.className = 'transcript-box';
    
    // Restaurar bot√≥n
    practiceBtn.textContent = 'üéôÔ∏è Practice';
    practiceBtn.style.background = '#0066cc';
    window.activeRecognition = null;
    window.activeRecognitionIndex = null;
    
    // Calcular puntuaci√≥n si hay transcripci√≥n
    const finalTranscript = fullTranscript.trim();
    if (finalTranscript) {
      transcriptBox.innerHTML = '‚úÖ <span style="color: #008000;">' + finalTranscript + '</span>';
      
      const target = lines[i].english.toLowerCase()
        .replace(/[^\w\s]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
      const score = compareText(target, finalTranscript.toLowerCase().trim());
      showScore(resultEl, score, finalTranscript);
    }
  };

  try {
    rec.start();
  } catch(e) {
    console.error('Error starting recognition:', e);
    transcriptBox.style.display = 'none';
    resultEl.textContent = '‚ö†Ô∏è Error: ' + e.message;
    resultEl.style.color = 'red';
    practiceBtn.textContent = 'üéôÔ∏è Practice';
    practiceBtn.style.background = '#0066cc';
    window.activeRecognition = null;
    window.activeRecognitionIndex = null;
  }
}

function compareText(original, spoken){
  // Normalizar ambos textos
  const normalize = (text) => {
    return text.toLowerCase()
      .replace(/[^\w\s]/g, '') // quitar puntuaci√≥n y s√≠mbolos
      .replace(/\s+/g, ' ')     // normalizar espacios
      .trim();
  };
  
  const origNorm = normalize(original);
  const spokenNorm = normalize(spoken);
  
  // Expandir contracciones comunes para mejor coincidencia
  const expandContractions = (text) => {
    const contractions = {
      'im': 'i am',
      'youre': 'you are',
      'hes': 'he is',
      'shes': 'she is',
      'its': 'it is',
      'were': 'we are',
      'theyre': 'they are',
      'ive': 'i have',
      'youve': 'you have',
      'weve': 'we have',
      'theyve': 'they have',
      'id': 'i would',
      'youd': 'you would',
      'hed': 'he would',
      'shed': 'she would',
      'wed': 'we would',
      'theyd': 'they would',
      'ill': 'i will',
      'youll': 'you will',
      'hell': 'he will',
      'shell': 'she will',
      'well': 'we will',
      'theyll': 'they will',
      'isnt': 'is not',
      'arent': 'are not',
      'wasnt': 'was not',
      'werent': 'were not',
      'havent': 'have not',
      'hasnt': 'has not',
      'hadnt': 'had not',
      'wont': 'will not',
      'wouldnt': 'would not',
      'dont': 'do not',
      'doesnt': 'does not',
      'didnt': 'did not',
      'cant': 'can not',
      'couldnt': 'could not',
      'shouldnt': 'should not',
      'lets': 'let us',
      'thats': 'that is',
      'whats': 'what is',
      'wheres': 'where is',
      'whens': 'when is',
      'whos': 'who is',
      'hows': 'how is'
    };
    
    let result = text;
    Object.keys(contractions).forEach(key => {
      const regex = new RegExp('\\b' + key + '\\b', 'g');
      result = result.replace(regex, contractions[key]);
    });
    return result;
  };
  
  const origExpanded = expandContractions(origNorm);
  const spokenExpanded = expandContractions(spokenNorm);
  
  const origWords = origExpanded.split(' ');
  const spokenWords = spokenExpanded.split(' ');
  
  // Contar palabras que coinciden (en cualquier orden pero preferir orden correcto)
  let matches = 0;
  let orderBonus = 0;
  const spokenCopy = [...spokenWords];
  
  origWords.forEach((origWord, origIndex) => {
    const index = spokenCopy.findIndex((spWord, spIndex) => {
      if(spWord === origWord) {
        // Bonus si est√° en posici√≥n similar
        if(Math.abs(origIndex - spIndex) <= 2) orderBonus++;
        return true;
      }
      return false;
    });
    
    if(index !== -1){
      matches++;
      spokenCopy.splice(index, 1);
    }
  });
  
  // Calcular score
  let score = Math.round((matches / origWords.length) * 100);
  
  // Bonus por orden correcto
  if(orderBonus > origWords.length * 0.5){
    score = Math.min(100, score + 3);
  }
  
  // Bonus por longitud similar
  const lengthRatio = Math.min(spokenWords.length, origWords.length) / Math.max(spokenWords.length, origWords.length);
  if(lengthRatio > 0.85 && score > 70){
    score = Math.min(100, score + 5);
  }
  
  return score;
}

function showScore(el, score, transcript){
  let color, feedback;
  if(score >= 80){ 
    color = 'green'; 
    feedback = '‚úÖ Excelente'; 
  } else if(score >= 60){ 
    color = 'orange'; 
    feedback = 'üëç Bien'; 
  } else if(score >= 40){
    color = 'orange';
    feedback = 'üìù Regular';
  } else { 
    color = 'red'; 
    feedback = 'üì¢ Necesita pr√°ctica'; 
  }
  el.innerHTML = feedback + ' (' + score + '%)<br><small>Dijiste: "' + transcript + '"</small>';
  el.style.color = color;
}
</script>
</body>
</html>
